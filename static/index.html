<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å·¥ä½œæ—¶é—´å°åŠ©æ‰‹</title>
    <style>
        :root {
            --primary-color: #667eea;
            --primary-hover: #5a6fd8;
            --secondary-color: #764ba2;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --card-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --border-color: #e5e7eb;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-gradient);
            min-height: 100vh;
            padding: 20px;
            color: var(--text-primary);
        }

        .main-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .container, .results-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            box-shadow: var(--card-shadow);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        h1 {
            font-size: 28px;
            color: var(--text-primary);
            margin-bottom: 30px;
            text-align: center;
            font-weight: 600;
            background: var(--bg-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-primary);
            font-size: 14px;
        }

        input[type="text"], select {
            width: 100%;
            padding: 15px 20px;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: #fff;
        }

        input[type="text"]:focus, select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .button-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 30px;
        }

        button {
            padding: 15px 25px;
            border: none;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: var(--bg-gradient);
            color: white;
            grid-column: span 2;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #fff;
            color: var(--primary-color);
            border: 2px solid var(--primary-color);
        }

        .btn-secondary:hover {
            background: var(--primary-color);
            color: white;
            transform: translateY(-1px);
        }

        .btn-success {
            background: var(--success-color);
            color: white;
        }

        .btn-warning {
            background: var(--warning-color);
            color: white;
        }

        .result {
            margin-top: 25px;
            padding: 20px;
            border-radius: 15px;
            font-size: 16px;
            line-height: 1.6;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border-left: 4px solid var(--primary-color);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        }

        .result h3 {
            color: var(--primary-color);
            margin-bottom: 15px;
            font-size: 18px;
        }

        .status-card {
            background: #fff;
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            border-left: 4px solid var(--success-color);
        }

        .status-card.working {
            border-left-color: var(--warning-color);
        }

        .status-card.off-work {
            border-left-color: var(--success-color);
        }

        .status-card.no-record {
            border-left-color: var(--danger-color);
        }

        .time-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .time-card {
            background: #fff;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        }

        .time-card .label {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .time-card .value {
            font-size: 24px;
            font-weight: 600;
            color: var(--primary-color);
        }

        .footer {
            margin-top: 40px;
            text-align: center;
            font-size: 14px;
            color: var(--text-secondary);
            opacity: 0.8;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .main-container {
                grid-template-columns: 1fr;
                gap: 20px;
                padding: 0 10px;
            }
            
            .container, .results-container {
                padding: 25px;
            }
            
            .button-grid {
                grid-template-columns: 1fr;
            }
            
            .btn-primary {
                grid-column: span 1;
            }
        }

        /* åŠ¨ç”»æ•ˆæœ */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .container, .results-container {
            animation: fadeIn 0.6s ease-out;
        }

        /* åŠ è½½çŠ¶æ€ */
        .loading {
            position: relative;
        }

        .loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            margin: -10px 0 0 -10px;
            border: 2px solid var(--primary-color);
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
<div class="main-container">
    <div class="container">
        <h1>ğŸ• å·¥ä½œæ—¶é—´å°åŠ©æ‰‹</h1>
        
        <div class="form-group">
            <label for="deviceSelect">é€‰æ‹©è®¾å¤‡</label>
            <select id="deviceSelect" onchange="handleDeviceChange()">
                <option value="å®">ğŸŒŸ å®</option>
                <option value="èƒ–">ğŸ’¼ èƒ–</option>
                <option value="custom">âœï¸ è‡ªå®šä¹‰</option>
            </select>
        </div>
        
        <div class="form-group">
            <input type="text" id="customDeviceInput" placeholder="è¯·è¾“å…¥è®¾å¤‡åç§°..." style="display:none;">
        </div>
        
        <div class="form-group">
            <label for="tagSelect">é€‰æ‹©æ ‡è®°</label>
            <select id="tagSelect">
                <option value="ç­¾åˆ°">âœ… ç­¾åˆ°</option>
                <option value="ä¸‹ç­">ğŸ  ä¸‹ç­</option>
                <option value="åˆä¼‘">ğŸ˜´ åˆä¼‘</option>
                <option value="å¤–å‡º">ğŸš¶ å¤–å‡º</option>
                <option value="ä¼šè®®">ğŸ‘¥ ä¼šè®®</option>
                <option value="åŸ¹è®­">ğŸ“š åŸ¹è®­</option>
            </select>
        </div>
        
        <div class="button-grid">
            <button class="btn-primary" onclick="saveCurrentTime()">ğŸ“ è®°å½•å½“å‰æ—¶é—´</button>
            <button class="btn-secondary" onclick="queryDeviceTimes()">ğŸ“Š æŸ¥è¯¢è®¾å¤‡æ—¶é—´</button>
            <button class="btn-secondary" onclick="queryTodayFirst()">â° ä»Šå¤©å·¥ä½œæ—¶é•¿</button>
            <button class="btn-secondary" onclick="queryByTag()">ğŸ” æŒ‰æ ‡è®°æŸ¥è¯¢</button>
            <button class="btn-success" onclick="queryDailyWorkHours()">ğŸ“ˆ æŸ¥è¯¢å·¥ä½œæ—¶é—´</button>
            <button class="btn-warning" onclick="navigateToEditPage()">âœï¸ ç¼–è¾‘é¡µé¢</button>
        </div>
        
        <div class="result" id="result"></div>
        <div class="footer">Â© 2024 èƒ–çˆ± | å·¥ä½œæ—¶é—´è¿½è¸ªåŠ©æ‰‹</div>
    </div>
    
    <div class="results-container">
        <h1>ğŸ“‹ å®æ—¶çŠ¶æ€</h1>
        <div class="status-card" id="resultBao">
            <div class="loading">åŠ è½½ä¸­...</div>
        </div>
        <div class="status-card" id="resultPan">
            <div class="loading">åŠ è½½ä¸­...</div>
        </div>
        
        <div class="time-info">
            <div class="time-card" style="grid-column: span 2;">
                <div class="label">ğŸ• å½“å‰æ—¶é—´</div>
                <div class="value" id="currentTime">--:--:--</div>
            </div>
        </div>
    </div>
</div>

<script>
    let firstTimestamp = null;

    // æ˜¾ç¤ºå½“å‰æ—¶é—´
    function updateCurrentTime() {
        const now = new Date();
        const timeString = now.toLocaleTimeString('zh-CN', {
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        });
        const currentTimeElement = document.getElementById('currentTime');
        if (currentTimeElement) {
            currentTimeElement.textContent = timeString;
        }
        
        // æ›´æ–°å€’è®¡æ—¶
        updateCountdown(now);
    }

    // æ›´æ–°å€’è®¡æ—¶åŠŸèƒ½ - æ”¯æŒå¤šè®¾å¤‡
    function updateCountdown(now = new Date()) {
        // æ›´æ–°å®çš„å€’è®¡æ—¶
        updateDeviceCountdown('å®', now);
        // æ›´æ–°èƒ–çš„å€’è®¡æ—¶
        updateDeviceCountdown('èƒ–', now);
    }
    
    // ä¸ºæŒ‡å®šè®¾å¤‡æ›´æ–°å€’è®¡æ—¶
    function updateDeviceCountdown(deviceName, now = new Date()) {
        const countdownElement = document.getElementById(`countdown-${deviceName}`);
        const targetTimeElement = document.getElementById(`targetTime-${deviceName}`);
        if (!countdownElement || !targetTimeElement) return;
        
        // æ£€æŸ¥è¯¥è®¾å¤‡æ˜¯å¦å·²ä¸‹ç­
        const isDeviceOffWork = window[`isOffWork_${deviceName}`] || false;
        
        // å¦‚æœå·²ç»ä¸‹ç­ï¼Œæ˜¾ç¤ºä¸‹ç­çŠ¶æ€
        if (isDeviceOffWork) {
            countdownElement.textContent = "âœ… å·²ä¸‹ç­";
            countdownElement.style.color = "var(--success-color)";
            return;
        }
        
        // è·å–è®¡åˆ’ä¸‹ç­æ—¶é—´å­—ç¬¦ä¸²
        const targetTimeStr = targetTimeElement.textContent || '18:00:00';
        
        // è§£æç›®æ ‡æ—¶é—´
        let targetTime;
        if (targetTimeStr.includes('-') || targetTimeStr.includes('/')) {
            // å®Œæ•´æ—¥æœŸæ—¶é—´æ ¼å¼
            targetTime = new Date(targetTimeStr);
        } else {
            // åªæœ‰æ—¶é—´æ ¼å¼ï¼Œä½¿ç”¨ä»Šå¤©çš„æ—¥æœŸ
            const [targetHour, targetMinute, targetSecond] = targetTimeStr.split(':').map(Number);
            
            // ä½¿ç”¨ä»Šå¤©çš„æ—¶é—´
            const today = new Date(now);
            targetTime = new Date(today.getFullYear(), today.getMonth(), today.getDate(), 
                                  targetHour, targetMinute, targetSecond);
        }
        
        // è®¡ç®—æ—¶é—´å·®
        const timeDiff = targetTime - now;
        
        // å¦‚æœæ—¶é—´å·®å°äºç­‰äº0ï¼ˆå·²è¿‡ä¸‹ç­æ—¶é—´ï¼‰
        if (timeDiff <= 0) {
            const overTime = Math.abs(timeDiff);
            const overHours = Math.floor(overTime / (1000 * 60 * 60));
            const overMinutes = Math.floor((overTime % (1000 * 60 * 60)) / (1000 * 60));
            const overSeconds = Math.floor((overTime % (1000 * 60)) / 1000);
            
            if (overHours > 0) {
                countdownElement.textContent = `â° å·²è¶…æ—¶ ${overHours}:${String(overMinutes).padStart(2, '0')}:${String(overSeconds).padStart(2, '0')}`;
            } else {
                countdownElement.textContent = `â° å·²è¶…æ—¶ ${overMinutes}:${String(overSeconds).padStart(2, '0')}`;
            }
            countdownElement.style.color = "var(--danger-color)";
            return;
        }
        
        // è½¬æ¢ä¸ºæ—¶åˆ†ç§’
        const hours = Math.floor(timeDiff / (1000 * 60 * 60));
        const minutes = Math.floor((timeDiff % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((timeDiff % (1000 * 60)) / 1000);
        
        // æ ¼å¼åŒ–æ˜¾ç¤º
        let countdownString;
        if (hours >= 24) {
            const days = Math.floor(hours / 24);
            const remainingHours = hours % 24;
            countdownString = `${days}å¤© ${String(remainingHours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        } else {
            countdownString = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }
        
        countdownElement.textContent = countdownString;
        
        // æ ¹æ®å‰©ä½™æ—¶é—´è®¾ç½®é¢œè‰²
        if (hours < 1) {
            countdownElement.style.color = "var(--danger-color)";
        } else if (hours < 2) {
            countdownElement.style.color = "var(--warning-color)";
        } else {
            countdownElement.style.color = "var(--primary-color)";
        }
    }

    // ä¸ºæŒ‡å®šè®¾å¤‡è®¾ç½®è®¡åˆ’ä¸‹ç­æ—¶é—´
    function setDeviceTargetTime(deviceName, firstTimestamp) {
        if (!firstTimestamp) {
            console.log(`âŒ setDeviceTargetTime: ${deviceName} æ²¡æœ‰é¦–æ¬¡ç­¾åˆ°æ—¶é—´`);
            return;
        }
        
        const firstTime = new Date(firstTimestamp);
        // åŠ 9å°æ—¶ä½œä¸ºè®¡åˆ’ä¸‹ç­æ—¶é—´
        const targetTime = new Date(firstTime.getTime() + 9 * 60 * 60 * 1000);
        
        const targetTimeStr = targetTime.toLocaleTimeString('zh-CN', {
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        });
        
        const targetTimeElement = document.getElementById(`targetTime-${deviceName}`);
        if (targetTimeElement) {
            targetTimeElement.textContent = targetTimeStr;
            console.log(`âœ… ${deviceName} è®¡åˆ’ä¸‹ç­æ—¶é—´å·²è®¾ç½®ä¸º: ${targetTimeStr} (é¦–æ¬¡ç­¾åˆ°: ${firstTimestamp})`);
        } else {
            console.log(`âŒ æ‰¾ä¸åˆ°å…ƒç´  targetTime-${deviceName}`);
        }
    }

    // è®¾ç½®è®¡åˆ’ä¸‹ç­æ—¶é—´ï¼ˆä¿ç•™åŸå‡½æ•°ç”¨äºå…¼å®¹ï¼‰
    function setTargetTime() {
        const newTime = prompt("è¯·è¾“å…¥è®¡åˆ’ä¸‹ç­æ—¶é—´ (æ ¼å¼: HH:MM:SS):", "18:00:00");
        if (newTime && /^\d{2}:\d{2}:\d{2}$/.test(newTime)) {
            const targetTimeElement = document.getElementById('targetTime');
            if (targetTimeElement) {
                targetTimeElement.textContent = newTime;
                // ç«‹å³æ›´æ–°å€’è®¡æ—¶
                updateCountdown();
                showSuccess("è®¡åˆ’ä¸‹ç­æ—¶é—´å·²è®¾ç½®ä¸º: " + newTime);
            }
        } else if (newTime !== null) {
            showError("æ—¶é—´æ ¼å¼ä¸æ­£ç¡®ï¼Œè¯·ä½¿ç”¨ HH:MM:SS æ ¼å¼");
        }
    }

    // è®¾ç½®åŠ è½½çŠ¶æ€
    function setLoading(elementId, isLoading = true) {
        const element = document.getElementById(elementId);
        if (element) {
            if (isLoading) {
                element.classList.add('loading');
                element.innerHTML = '<div>åŠ è½½ä¸­...</div>';
            } else {
                element.classList.remove('loading');
            }
        }
    }

    // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
    function showSuccess(message) {
        // å¯ä»¥æ·»åŠ toasté€šçŸ¥æˆ–å…¶ä»–æˆåŠŸæç¤º
        console.log('æˆåŠŸ:', message);
    }

    // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
    function showError(message) {
        // å¯ä»¥æ·»åŠ toasté€šçŸ¥æˆ–å…¶ä»–é”™è¯¯æç¤º
        console.error('é”™è¯¯:', message);
        alert(message);
    }

    function handleDeviceChange() {
        const deviceSelect = document.getElementById('deviceSelect');
        const customDeviceInput = document.getElementById('customDeviceInput');
        const formGroup = customDeviceInput.parentElement;
        
        if (deviceSelect.value === 'custom') {
            formGroup.style.display = 'block';
            customDeviceInput.focus();
        } else {
            formGroup.style.display = 'none';
            // å½“åˆ‡æ¢è®¾å¤‡æ—¶ï¼Œé‡æ–°è®¾ç½®è®¡åˆ’ä¸‹ç­æ—¶é—´
            setTimeout(setDefaultTargetTime, 500);
        }
    }

    function getDeviceName() {
        const deviceSelect = document.getElementById('deviceSelect');
        const customDeviceInput = document.getElementById('customDeviceInput');
        if (deviceSelect.value === 'custom') {
            return customDeviceInput.value;
        } else {
            return deviceSelect.value;
        }
    }

    function saveCurrentTime() {
        const deviceName = getDeviceName();
        const tagSelect = document.getElementById('tagSelect');
        const tag = tagSelect.value;
        const resultDiv = document.getElementById('result');

        if (!deviceName) {
            resultDiv.innerHTML = 'è¯·è¾“å…¥è®¾å¤‡åç§°ã€‚';
            return;
        }

        const data = { device_name: deviceName, tag: tag };

        fetch('/save', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        })
            .then(response => response.json())
            .then(data => {
                resultDiv.innerHTML = `æ—¶é—´è®°å½•æˆåŠŸï¼Œæ ‡è®°ä¸ºï¼š${data.tag}`;
                queryDefaultDevices();
                // é‡æ–°è®¾ç½®è®¡åˆ’ä¸‹ç­æ—¶é—´
                setTimeout(setDefaultTargetTime, 500);
            })
            .catch(error => {
                console.error('Error:', error);
                resultDiv.innerHTML = 'æ—¶é—´è®°å½•å¤±è´¥ã€‚';
            });
    }
    function queryDeviceTimes() {
        const deviceName = getDeviceName();
        const resultDiv = document.getElementById('result');

        if (!deviceName) {
            resultDiv.innerHTML = 'è¯·è¾“å…¥è®¾å¤‡åç§°ã€‚';
            return;
        }

        fetch(`/query?device_name=${encodeURIComponent(deviceName)}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    resultDiv.innerHTML = data.error;
                } else {
                    let recordsHtml = `è®¾å¤‡ ${deviceName} çš„è®°å½•ï¼š<br>`;
                    data.records.forEach(record => {
                        recordsHtml += `${record.timestamp} (${record.tag})<br>`;
                    });
                    recordsHtml += `<br>ä»Šå¤©æœ€æ—©çš„è®°å½•ï¼š${data.today_first_timestamp} (${data.today_first_tag})<br>åˆ°ç°åœ¨å·²ç»è¿‡äº†ï¼š${data.elapsed_time}`;
                    resultDiv.innerHTML = recordsHtml;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                resultDiv.innerHTML = 'æŸ¥è¯¢å¤±è´¥ã€‚';
            });
    }

    function queryTodayFirst() {
        const deviceName = getDeviceName();
        const resultDiv = document.getElementById('result');

        if (!deviceName) {
            resultDiv.innerHTML = 'è¯·è¾“å…¥è®¾å¤‡åç§°ã€‚';
            return;
        }

        fetch(`/query_today_first?device_name=${encodeURIComponent(deviceName)}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    resultDiv.innerHTML = data.error;
                } else {
                    resultDiv.innerHTML = `${deviceName} ä»Šå¤©å·²ç»å·¥ä½œäº†ï¼š${data.elapsed_time}`;
                    queryDefaultDevices()
                }
            })
            .catch(error => {
                console.error('Error:', error);
                resultDiv.innerHTML = 'æŸ¥è¯¢å¤±è´¥ã€‚';
            });
    }

    function queryByTag() {
        const deviceName = getDeviceName();
        const tagSelect = document.getElementById('tagSelect');
        const tag = tagSelect.value;
        const resultDiv = document.getElementById('result');

        if (!deviceName) {
            resultDiv.innerHTML = 'è¯·è¾“å…¥è®¾å¤‡åç§°ã€‚';
            return;
        }

        fetch(`/query_by_tag?device_name=${encodeURIComponent(deviceName)}&tag=${encodeURIComponent(tag)}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    resultDiv.innerHTML = data.error;
                } else {
                    let recordsHtml = `è®¾å¤‡ ${deviceName} çš„ "${tag}" è®°å½• (å…±${data.total}æ¡)ï¼š<br>`;
                    data.records.forEach(record => {
                        recordsHtml += `${record.timestamp} (${record.tag})<br>`;
                    });
                    resultDiv.innerHTML = recordsHtml;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                resultDiv.innerHTML = 'æŸ¥è¯¢å¤±è´¥ã€‚';
            });
    }

    function queryDailyWorkHours() {
        const deviceName = getDeviceName();
        const resultDiv = document.getElementById('result');

        if (!deviceName) {
            resultDiv.innerHTML = 'è¯·è¾“å…¥è®¾å¤‡åç§°ã€‚';
            return;
        }

        // æŸ¥è¯¢æœ€è¿‘7å¤©çš„å·¥ä½œæ—¶é—´
        const endDate = new Date().toISOString().split('T')[0];
        const startDate = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];

        fetch(`/query_daily_work_hours?device_name=${encodeURIComponent(deviceName)}&start_date=${startDate}&end_date=${endDate}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    resultDiv.innerHTML = data.error;
                } else {
                    let workHoursHtml = `<h3>${deviceName} æœ€è¿‘7å¤©å·¥ä½œæ—¶é—´ï¼š</h3>`;
                    
                    if (data.daily_work_hours.length === 0) {
                        workHoursHtml += 'æš‚æ— å·¥ä½œè®°å½•';
                    } else {
                        workHoursHtml += `<div style="font-size: 12px; margin-bottom: 10px;">å·²å®Œæˆå¤©æ•°ï¼š${data.completed_days}/${data.total_days}</div>`;
                        
                        // æŒ‰æ—¥æœŸå€’åºæ˜¾ç¤ºï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
                        data.daily_work_hours.reverse().forEach(day => {
                            const statusColor = day.status === 'å·²å®Œæˆ' ? '#28a745' : 
                                              day.status === 'è¿›è¡Œä¸­' ? '#ffc107' : '#6c757d';
                            
                            workHoursHtml += `
                                <div style="border: 1px solid #ddd; padding: 10px; margin: 5px 0; border-radius: 5px;">
                                    <div style="font-weight: bold;">${day.date}</div>
                                    <div>ç­¾åˆ°: ${day.first_checkin || 'æœªç­¾åˆ°'} | ä¸‹ç­: ${day.last_checkout || 'æœªä¸‹ç­'}</div>
                                    <div>å·¥ä½œæ—¶é•¿: ${day.work_duration || 'è®¡ç®—ä¸­'} (${day.work_hours}å°æ—¶)</div>
                                    <div style="color: ${statusColor};">çŠ¶æ€: ${day.status} | è®°å½•æ•°: ${day.records_count}</div>
                                </div>
                            `;
                        });
                    }
                    
                    resultDiv.innerHTML = workHoursHtml;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                resultDiv.innerHTML = 'æŸ¥è¯¢å¤±è´¥ã€‚';
            });
    }

    function queryDefaultDevices() {
        queryTodayFirstForDevice('å®', 'resultBao');
        queryTodayFirstForDevice('èƒ–', 'resultPan');
    }

    function queryTodayFirstForDevice(deviceName, resultElementId) {
        const resultDiv = document.getElementById(resultElementId);
        setLoading(resultElementId, true);

        fetch(`/query?device_name=${encodeURIComponent(deviceName)}`)
            .then(response => response.json())
            .then(data => {
                setLoading(resultElementId, false);
                
                if (data.error || data.message === 'No records for today') {
                    resultDiv.className = 'status-card no-record';
                    resultDiv.innerHTML = `
                        <h3>${deviceName}</h3>
                        <p>ğŸš« ä»Šæ—¥å°šæœªç­¾åˆ°</p>
                        <small>ç­‰å¾…ç¬¬ä¸€æ¬¡è®°å½•...</small>
                    `;
                } else {
                    // ä½¿ç”¨åç«¯è¿”å›çš„ä¸‹ç­çŠ¶æ€å’Œæœ€åæ ‡è®°
                    const isOffWork = data.is_off_work || false;
                    const lastTag = data.last_tag || data.today_first_tag;
                    
                    // è®¾ç½®è¯¥è®¾å¤‡çš„ä¸‹ç­çŠ¶æ€
                    window[`isOffWork_${deviceName}`] = isOffWork;
                    
                    // æ˜¾ç¤ºå·¥ä½œæ—¶é—´ï¼ˆåç«¯å·²ç»æ ¹æ®ä¸‹ç­çŠ¶æ€æ­£ç¡®è®¡ç®—ï¼‰
                    const displayTime = data.elapsed_time;
                    
                    resultDiv.className = isOffWork ? 'status-card off-work' : 'status-card working';
                    resultDiv.innerHTML = `
                        <h3>${deviceName}</h3>
                        <div style="font-size: 24px; font-weight: 600; color: ${isOffWork ? 'var(--success-color)' : 'var(--warning-color)'}; margin: 10px 0;">
                            å·²å·¥ä½œ: ${displayTime}
                        </div>
                        <div style="margin: 15px 0;">
                            <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 5px;">
                                ğŸ“ é¦–æ¬¡ç­¾åˆ°: ${data.today_first_timestamp.split(' ')[1]}
                            </div>
                            <div style="display: inline-block;">
                                <span style="background: ${isOffWork ? 'var(--success-color)' : 'var(--warning-color)'}; 
                                             color: white; padding: 4px 10px; border-radius: 12px; font-size: 12px;">
                                    ${lastTag}
                                </span>
                            </div>
                            ${isOffWork && data.last_timestamp ? `
                            <div style="font-size: 12px; color: var(--text-secondary); margin-top: 5px;">
                                ğŸ ä¸‹ç­æ—¶é—´: ${data.last_timestamp.split(' ')[1]}
                            </div>
                            ` : ''}
                        </div>
                        
                        <!-- è®¡åˆ’ä¸‹ç­æ—¶é—´å’Œå€’è®¡æ—¶ -->
                        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border-color);">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 12px;">
                                <div>
                                    <div style="color: var(--text-secondary);">ğŸ  è®¡åˆ’ä¸‹ç­</div>
                                    <div style="font-weight: 600; color: var(--primary-color);" id="targetTime-${deviceName}">18:00:00</div>
                                </div>
                                <div>
                                    <div style="color: var(--text-secondary);">â³ è·ç¦»ä¸‹ç­</div>
                                    <div style="font-weight: 600;" id="countdown-${deviceName}">--:--:--</div>
                                </div>
                            </div>
                        </div>
                        
                        <small style="margin-top: 10px; display: block;">${isOffWork ? 'âœ… ä»Šæ—¥å·¥ä½œå®Œæˆ' : 'â° æ­£åœ¨å·¥ä½œä¸­...'}</small>
                    `;
                    
                    // åœ¨HTMLæ¸²æŸ“å®Œæˆåè®¾ç½®è®¡åˆ’ä¸‹ç­æ—¶é—´
                    setTimeout(() => {
                        if (data.today_first_timestamp) {
                            setDeviceTargetTime(deviceName, data.today_first_timestamp);
                        }
                    }, 100);
                }
            })
            .catch(error => {
                setLoading(resultElementId, false);
                console.error('Error:', error);
                resultDiv.className = 'status-card no-record';
                resultDiv.innerHTML = `
                    <h3>${deviceName}</h3>
                    <p>âŒ æŸ¥è¯¢å¤±è´¥</p>
                    <small>è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥</small>
                `;
            });
    }

    function navigateToEditPage() {
        window.location.href = '/edit';
    }

    function updateElapsedTime(resultElementId, firstTimestamp) {
        const resultDiv = document.getElementById(resultElementId);
        if (!resultDiv) {
            console.error(`Element with id ${resultElementId} not found.`);
            return;
        }

        const now = new Date();
        const elapsed = now - new Date(firstTimestamp);

        const hours = Math.floor(elapsed / (1000 * 60 * 60));
        const minutes = Math.floor((elapsed % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((elapsed % (1000 * 60)) / 1000);

        resultDiv.innerHTML = `${resultDiv.id.includes('Bao') ? 'å®' : 'èƒ–'} ä»Šå¤©å·²ç»å·¥ä½œäº†ï¼š${hours}å°æ—¶ ${minutes}åˆ†é’Ÿ ${seconds}ç§’`;
    }

    // è®¾ç½®é»˜è®¤è®¡åˆ’ä¸‹ç­æ—¶é—´ä¸ºç¬¬ä¸€æ¬¡ç­¾åˆ°+9å°æ—¶ï¼ˆä¿ç•™ç”¨äºå½“å‰ç”¨æˆ·é€‰æ‹©çš„è®¾å¤‡ï¼‰
    function setDefaultTargetTime() {
        const deviceSelect = document.getElementById('deviceSelect');
        const currentDevice = deviceSelect.value === 'custom' ? 
            document.getElementById('customDeviceInput').value : deviceSelect.value;
        
        const targetTimeElement = document.getElementById('targetTime');
        if (!targetTimeElement) return;
            
        if (!currentDevice) {
            // å¦‚æœæ²¡æœ‰é€‰æ‹©è®¾å¤‡ï¼Œä½¿ç”¨é»˜è®¤å€¼
            targetTimeElement.textContent = '18:00:00';
            console.log('æœªé€‰æ‹©è®¾å¤‡ï¼Œä½¿ç”¨é»˜è®¤è®¡åˆ’ä¸‹ç­æ—¶é—´: 18:00:00');
            return;
        }
        
        fetch(`/query?device_name=${encodeURIComponent(currentDevice)}`)
            .then(response => response.json())
            .then(data => {
                if (data.error || data.message === 'No records for today') {
                    // æ²¡æœ‰ä»Šå¤©çš„è®°å½•ï¼Œä½¿ç”¨é»˜è®¤18:00:00
                    targetTimeElement.textContent = '18:00:00';
                    console.log(`è®¾å¤‡ ${currentDevice} ä»Šå¤©æš‚æ— ç­¾åˆ°è®°å½•ï¼Œä½¿ç”¨é»˜è®¤è®¡åˆ’ä¸‹ç­æ—¶é—´: 18:00:00`);
                    return;
                }
                
                // è§£æç¬¬ä¸€æ¬¡ç­¾åˆ°æ—¶é—´
                const firstTimestamp = data.today_first_timestamp;
                if (firstTimestamp) {
                    const firstTime = new Date(firstTimestamp);
                    // åŠ 9å°æ—¶ä½œä¸ºè®¡åˆ’ä¸‹ç­æ—¶é—´
                    const targetTime = new Date(firstTime.getTime() + 9 * 60 * 60 * 1000);
                    
                    const targetTimeStr = targetTime.toLocaleTimeString('zh-CN', {
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit'
                    });
                    
                    targetTimeElement.textContent = targetTimeStr;
                    console.log(`å·²è‡ªåŠ¨è®¾ç½®è®¡åˆ’ä¸‹ç­æ—¶é—´ä¸º: ${targetTimeStr} (ç¬¬ä¸€æ¬¡ç­¾åˆ°+9å°æ—¶)`);
                    console.log(`ç¬¬ä¸€æ¬¡ç­¾åˆ°æ—¶é—´: ${firstTime.toLocaleTimeString('zh-CN')}`);
                } else {
                    // å¦‚æœæ²¡æœ‰æœ‰æ•ˆçš„ç­¾åˆ°æ—¶é—´ï¼Œä½¿ç”¨é»˜è®¤å€¼
                    targetTimeElement.textContent = '18:00:00';
                    console.log('æ— æ³•è·å–ç­¾åˆ°æ—¶é—´ï¼Œä½¿ç”¨é»˜è®¤è®¡åˆ’ä¸‹ç­æ—¶é—´: 18:00:00');
                }
            })
            .catch(error => {
                console.error('è·å–ç­¾åˆ°æ—¶é—´å¤±è´¥:', error);
                // å¤±è´¥æ—¶ä½¿ç”¨é»˜è®¤å€¼
                targetTimeElement.textContent = '18:00:00';
                console.log('è·å–ç­¾åˆ°æ—¶é—´å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤è®¡åˆ’ä¸‹ç­æ—¶é—´: 18:00:00');
            });
    }

    // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
        // æ›´æ–°å½“å‰æ—¶é—´å’Œå€’è®¡æ—¶
        updateCurrentTime();
        setInterval(updateCurrentTime, 1000);
        
        // æŸ¥è¯¢é»˜è®¤è®¾å¤‡çŠ¶æ€
        queryDefaultDevices();
        
        // æ¯30ç§’è‡ªåŠ¨åˆ·æ–°çŠ¶æ€
        setInterval(queryDefaultDevices, 30000);
        
        // è‡ªåŠ¨è®¾ç½®è®¡åˆ’ä¸‹ç­æ—¶é—´ä¸ºç¬¬ä¸€æ¬¡ç­¾åˆ°+9å°æ—¶ï¼Œå¦‚æœæ²¡æœ‰ç­¾åˆ°è®°å½•åˆ™ä½¿ç”¨é»˜è®¤18:00:00
        setTimeout(setDefaultTargetTime, 1000); // å»¶è¿Ÿ1ç§’ç­‰é¡µé¢å®Œå…¨åŠ è½½
        
        // ç›‘å¬è‡ªå®šä¹‰è®¾å¤‡è¾“å…¥æ¡†å˜åŒ–
        const customDeviceInput = document.getElementById('customDeviceInput');
        customDeviceInput.addEventListener('input', function() {
            // è¾“å…¥è®¾å¤‡ååé‡æ–°è®¾ç½®è®¡åˆ’ä¸‹ç­æ—¶é—´
            clearTimeout(window.deviceInputTimer);
            window.deviceInputTimer = setTimeout(() => {
                setDefaultTargetTime();
            }, 1000);
        });
        
        console.log('å·¥ä½œæ—¶é—´å°åŠ©æ‰‹å·²åˆå§‹åŒ– ğŸš€');
    });
</script>
</body>
</html>