name: Build and Push Docker Image with Tag

on:
  push:
    branches:
      - master  # å½“æŽ¨é€åˆ° master åˆ†æ”¯æ—¶è§¦å‘
  pull_request:
    branches:
      - master  # å½“å‘ master åˆ†æ”¯æäº¤ pull request æ—¶è§¦å‘

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v1

      - name: Log in to Docker Hub
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Extract version and build metadata
        id: meta
        run: |
          # èŽ·å–å½“å‰æ—¥æœŸä½œä¸ºç‰ˆæœ¬å·çš„ä¸€éƒ¨åˆ†
          BUILD_DATE=$(date +'%Y%m%d')
          
          # èŽ·å– Git ä¿¡æ¯
          GIT_SHA=$(git rev-parse --short HEAD)
          GIT_BRANCH=${GITHUB_REF#refs/heads/}
          
          # æ£€æŸ¥æ˜¯å¦æœ‰ Git æ ‡ç­¾
          if git describe --tags --exact-match HEAD 2>/dev/null; then
            # å¦‚æžœå½“å‰ commit æœ‰æ ‡ç­¾ï¼Œä½¿ç”¨æ ‡ç­¾ä½œä¸ºç‰ˆæœ¬
            VERSION=$(git describe --tags --exact-match HEAD)
            echo "Found git tag: $VERSION"
          else
            # ç”Ÿæˆé€’å¢žçš„æž„å»ºåºå·
            # ä½¿ç”¨ GitHub run number ç¡®ä¿ä¸¥æ ¼é€’å¢ž
            RUN_NUMBER=${{ github.run_number }}
            
            # ä¹Ÿå¯ä»¥åŸºäºŽæ—¶é—´ç”Ÿæˆï¼Œä½†åŠ å…¥ç§’æ•°ç¡®ä¿å”¯ä¸€æ€§
            TIMESTAMP=$(date +'%H%M%S')
            
            # æ–¹æ¡ˆ1: ä½¿ç”¨ GitHub run number (æŽ¨è)
            VERSION="v1.${BUILD_DATE}.${RUN_NUMBER}"
            
            # æ–¹æ¡ˆ2: ä½¿ç”¨æ—¶é—´æˆ³åˆ°ç§’ (å¤‡é€‰)
            # VERSION="v1.${BUILD_DATE}.${TIMESTAMP}"
            
            echo "Generated version: $VERSION (using run number: $RUN_NUMBER)"
          fi
          
          echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT
          echo "BUILD_DATE=${BUILD_DATE}" >> $GITHUB_OUTPUT
          echo "GIT_SHA=${GIT_SHA}" >> $GITHUB_OUTPUT
          echo "GIT_BRANCH=${GIT_BRANCH}" >> $GITHUB_OUTPUT
          echo "RUN_NUMBER=${{ github.run_number }}" >> $GITHUB_OUTPUT
          
          echo "Build metadata:"
          echo "  Version: $VERSION"
          echo "  Build Date: $BUILD_DATE"
          echo "  Git SHA: $GIT_SHA"
          echo "  Git Branch: $GIT_BRANCH"
          echo "  Run Number: ${{ github.run_number }}"

      - name: Build and push Docker multi-arch image
        uses: docker/build-push-action@v2
        with:
          context: .
          push: true
          platforms: linux/amd64,linux/arm64
          tags: |
            xiebaiyuan/work-timer:${{ steps.meta.outputs.VERSION }}
            xiebaiyuan/work-timer:latest
            xiebaiyuan/work-timer:${{ steps.meta.outputs.BUILD_DATE }}
            xiebaiyuan/work-timer:sha-${{ steps.meta.outputs.GIT_SHA }}
          labels: |
            org.opencontainers.image.title=Work Timer
            org.opencontainers.image.description=A simple work time tracking application
            org.opencontainers.image.version=${{ steps.meta.outputs.VERSION }}
            org.opencontainers.image.created=${{ steps.meta.outputs.BUILD_DATE }}
            org.opencontainers.image.revision=${{ steps.meta.outputs.GIT_SHA }}
            org.opencontainers.image.source=https://github.com/xiebaiyuan/work-timer

      - name: Create GitHub Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.meta.outputs.VERSION }}
          release_name: Work Timer ${{ steps.meta.outputs.VERSION }}
          body: |
            ## ðŸš€ Work Timer Release ${{ steps.meta.outputs.VERSION }}
            
            ### ðŸ“¦ Docker Images
            - `xiebaiyuan/work-timer:${{ steps.meta.outputs.VERSION }}`
            - `xiebaiyuan/work-timer:latest`
            - `xiebaiyuan/work-timer:${{ steps.meta.outputs.BUILD_DATE }}`
            - `xiebaiyuan/work-timer:sha-${{ steps.meta.outputs.GIT_SHA }}`
            
            ### ðŸ”§ Build Information
            - **Build Date**: ${{ steps.meta.outputs.BUILD_DATE }}
            - **Git SHA**: ${{ steps.meta.outputs.GIT_SHA }}
            - **Run Number**: ${{ steps.meta.outputs.RUN_NUMBER }}
            - **Platforms**: linux/amd64, linux/arm64
            
            ### ðŸ“ˆ Version Format
            - **Format**: `v1.{BUILD_DATE}.{RUN_NUMBER}`
            - **Explanation**: Run number ensures strictly increasing version numbers
            
            ### ðŸ“– Usage
            ```bash
            docker run -d -p 8000:5000 xiebaiyuan/work-timer:${{ steps.meta.outputs.VERSION }}
            ```
          draft: false
          prerelease: false